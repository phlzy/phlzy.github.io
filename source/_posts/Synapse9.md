---
title: S9-Kelly Criterion
date: 2026-02-17
tags: [probability]
categories: [Synapse]
math: true
---

maximize geometric growth rate

<!--more-->

# Geometric Growth Rate

在投资的场景下，假设收益率分别是 $r_1, r_2, ... r_n$，如何量化长期的平均收益率？

- 算术平均：$\frac{r_1 + r_2 + ... + r_n}{n}$
- 几何平均：$\sqrt[n]{(1+r_1) \times (1+r_2) \times ... \times (1+r_n)} - 1$

算术平均在这里没有意义，即便算术平均是正数，收益也很可能是负的。几何平均的形式反应了真实的情况。

从两者的对比来看，波动率会拖累长期收益。 盈亏的幅度越大，几何增长率的折损就越严重，这个现象被称为 Volatility Tax。

# Kelly Criterion

在已知胜率和赔率的情况下，我应该把多少比例的本金用于下注或投资，才能使长期收益最大化？

几何平均增长率显示，如果每次下注很小的比例，资金更安全，但是效率低下，反之亦然。

如何在效率和安全性上做一个 tradeoff，就是 Kelly Criterion 解决的问题。

## 建模

假设初始本金 $V_0$，$f$ 是你每次下注的比例，$b$ 是净赔率（即赢了赚 $b$ 倍，输了赔光下注额），$p$ 是赢的概率，$q$ 是输的概率（满足 $q = 1 - p$）。

假设进行了 $N$ 次下注，其中赢了 $W$ 次，输了 $L$ 次，显然 $W + L = N$。

$N$ 次下注后的最终财富 $V_N$ 为：

$$
V_N = V_0 \cdot (1 + fb)^W \cdot (1 - f)^L
$$

我们要最大化的是 $V_N$ 相对于 $V_0$ 的增长速度，也就是最大化 $V_N$：

$$
\max_{f\in [0,1]} \frac{1}{N}V_N
$$

## 推导

为了方便求导，在等式两边同时取对数：

$$
\ln(V_N) = \ln(V_0) + W \ln(1 + fb) + L \ln(1 - f)
$$

将两边除以 $N$，得到平均每次下注的对数增长率：

$$
\frac{\ln(V_N) - \ln(V_0)}{N} = \frac{W}{N} \ln(1 + fb) + \frac{L}{N} \ln(1 - f)
$$

根据大数定律，有
$$
\lim_{N\to \infty}\frac{\ln(V_N) - \ln(V_0)}{N} = p \ln(1 + fb) + q \ln(1 - f)
$$


所以，长期的**预期指数增长率 (Expected Geometric Growth Rate)**，记为 $G(f)$，可以表示为：

$$
G(f) = p \ln(1 + fb) + q \ln(1 - f)
$$

现在的任务变成了：找到一个 $f$，使得函数 $G(f)$ 的值最大。这就是一个寻找极值点的问题，先对 $G(f)$ 求一阶导：

$$
G'(f) = \frac{\mathrm d}{\mathrm d f} [p \ln(1 + fb) + q \ln(1 - f)]\\
= \frac{pb}{1+fb}- \frac{q}{1-f}
$$

这看起来很不错，再求二阶导，有：

$$
G''(f) = -\frac{pb^2}{(1+fb)^2}- \frac{q}{(1-f)^2} < 0
$$

这是一个完美的凹函数，那么一阶导的零点就是原函数的最大值点，即：
$$
\frac{pb}{1+f^\star \cdot b} = \frac{q}{1-f^\star}\\
f^\star=\frac{pb-q}{b}
$$
这就是凯利公式的结论了。

## 一些性质

把这个推出来的 $f^\star=\frac{pb-q}{b}$ 代回去，可以发现每次下注的时候，

- 如果获胜，资金变为 $p(b+1)$
- 如果失败，资金变为 $\frac{q(b+1)}{b}$

再代入 $G(f)$，有：
$$
G_{\max}=p\ln \left[p(b+1) \right]+q\ln \left[ \frac{q(b+1)}{b}\right]
$$
整理一下，得到 $G_{\max}=\ln(b+1)-q\ln b+(p\ln p+q\ln q)$。

后面的这个东西看起来很熟悉，正是无处不在的香农熵/交叉熵/KL 散度。

> 一个有趣的变形：
>
> 改写前两项，令 $\ln(b+1)=-\ln r$，那么 $-q\ln b=q\ln \frac{r}{1-r}$。
>
> 此时，$G_{\max}=p\ln \frac{p}{r}+q\ln \frac{q}{1-r}$，这是真实结果 $(p,q)$ 相对赔率隐含分布 $(r,1-r)$ 的 KL 散度。
>
> 这里的 $r=\frac{1}{b+1}$，正是庄家通过赔率暗示的胜率。从这个角度来看，赔率本身就是一种隐含的概率分布。
>
> 当年 J. L. Kelly 在贝尔实验室写这篇论文时，标题就是 A New Interpretation of Information Rate。
>
> 在内幕交易中，内幕消息的信息传输速度，就是财富倍增速度。

所以说，财富增长速度，本质上取决于对这个赌局拥有的信息优势。

### 另一个视角

根据泰勒展开，有
$$
\ln(1+x) =\sum_{n=1}^{\infty}(-1)^{n+1}\frac{x^n}{n} \approx x - \frac{x^2}{2}
$$
假设我们进行一次下注：

- $f$：下注比例。
- $R$：是一个随机变量，代表此次下注的收益率（例如赢了是 $+b$，输了是 $-1$）。

我们的资金增长倍数是 $(1 + fR)$。

根据凯利理论，我们要最大化的是**期望对数收益（几何增长率）** $G(f)$：

$$
G(f) = \mathbb{E}[\ln(1 + fR)]
$$

现在，我们将 $\ln(1 + fR)$ 替换为它的泰勒近似公式（假设 $fR$ 比较小）：

$$
G(f) \approx \mathbb{E}\left[ fR - \frac{(fR)^2}{2} \right]
$$

利用期望值的线性性：

$$
G(f) \approx f \cdot \mathbb{E}[R] - \frac{f^2}{2} \cdot \mathbb{E}[R^2]
$$

在这个式子里，我们可以识别出两个非常熟悉的统计学概念：

1. $\mathbb{E}[R]$：这是期望收益（Expected Return），也就是我们通常说的“优势”（Edge），记作 $\mu$。
2. $\mathbb{E}[R^2]$：这是收益的二阶矩。在收益率较小的情况下，它近似等于收益的方差（Variance），记作 $\sigma^2$。

于是，我们的近似公式变成了著名的“波动率拖累公式”：
$$
G(f) \approx f\mu - \frac{f^2 \sigma^2}{2}
$$

> **含义**：你的几何增长率 = （仓位 $\times$ 优势） - （仓位引起的波动惩罚）。

显然，在这个公式中，最优解 $f^\star=\frac{\mu}{\sigma^2}$。代回去，得到 $G_{\max} \approx \frac{\mu^2 }{2\sigma^2}$。

如果在 $b=1$​（1赔1）的情况下：

- 赢了赚1倍，输了亏1倍。
- 收益 $R$ 的取值是 $+1$ 或 $-1$。
- 那么 $R^2$ 恒等于 1（因为 $1^2=1, (-1)^2=1$）。
- 所以 方差 $\sigma^2 \approx \mathbb{E}[R^2] = 1$。

将 $\sigma^2 = 1$ 代入上面的公式：$G_{\max} \approx \frac{\mu^2 }{2}$。由此可见，在这种场景下，长期的财富增长速度，与你优势（Edge）的平方成正比。

- 如果把优势提高 2 倍（比如通过研究把胜率从 51% 提到 52%），财富积累速度不是变成 2 倍，而是变成 4 倍！
- 这就是为什么职业交易员和德州扑克高手会为了仅仅 1% 的胜率提升而绞尽脑汁，因为在凯利公式下，这一点的提升在长期复利中会被平方级放大。

> 既然算出了增长率 $G_{max}$，我们就可以算出资金翻倍需要多少次下注。
>
> $$
> n = \frac{\ln 2}{G_{max}} \approx \frac{0.693}{G_{max}}
> $$
>
> 假设你有 2% 的优势（Edge = 0.02），赔率是 1:1。
>
> - 根据近似公式，$G_{max} \approx \frac{0.02^2}{2} = 0.0002$（即每次下注平均复利增长 0.02%）。
>- 翻倍所需次数 $n \approx \frac{0.693}{0.0002} \approx 3465$ 次。
> 
> **这个性质的含义：**
>
> 它让你清醒。即使你有数学优势，如果优势很小，你需要下注非常多次（几千次）才能看到显著的财富增长。这解释了为什么“短线高频交易”喜欢微小的优势，而“长线投资”需要巨大的优势。







